<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Usage Dashboard - NYC Renovation Experts</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: #f5f7fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .stat-card .icon {
            font-size: 2.5rem;
            color: #667eea;
            margin-bottom: 1rem;
        }
        .stat-card h3 {
            font-size: 2rem;
            font-weight: bold;
            margin: 0;
        }
        .stat-card p {
            color: #666;
            margin: 0.5rem 0 0 0;
        }
        .logs-table {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .badge-success {
            background: #28a745;
        }
        .badge-danger {
            background: #dc3545;
        }
        .login-form {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        .table-responsive {
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-form">
        <h2 class="mb-4"><i class="fas fa-lock me-2"></i>Admin Login</h2>
        <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" class="form-control" id="adminPassword" placeholder="Enter admin password">
        </div>
        <button class="btn btn-primary w-100" onclick="login()">
            <i class="fas fa-sign-in-alt me-2"></i>Login
        </button>
        <div id="loginError" class="alert alert-danger mt-3 d-none"></div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="d-none">
        <div class="dashboard-header">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1><i class="fas fa-chart-line me-2"></i>API Usage Dashboard</h1>
                        <p class="mb-0">Monitor your AI API usage and costs</p>
                    </div>
                    <button class="btn btn-light" onclick="logout()">
                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>

        <div class="container">
            <!-- Statistics Cards -->
            <div class="row">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="icon"><i class="fas fa-phone-alt"></i></div>
                        <h3 id="totalCalls">0</h3>
                        <p>Total API Calls</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="icon"><i class="fas fa-coins"></i></div>
                        <h3 id="totalCost">$0.00</h3>
                        <p>Total Cost</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="icon"><i class="fas fa-layer-group"></i></div>
                        <h3 id="totalTokens">0</h3>
                        <p>Total Tokens</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="icon"><i class="fas fa-check-circle"></i></div>
                        <h3 id="successRate">0%</h3>
                        <p>Success Rate</p>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="chart-container">
                        <h5 class="mb-3"><i class="fas fa-chart-bar me-2"></i>Usage by Date</h5>
                        <canvas id="usageChart"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-container">
                        <h5 class="mb-3"><i class="fas fa-chart-pie me-2"></i>Usage by Endpoint</h5>
                        <canvas id="endpointChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Logs -->
            <div class="logs-table">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5><i class="fas fa-list me-2"></i>Recent API Calls</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-danger me-2" onclick="clearLogs()">
                            <i class="fas fa-trash me-2"></i>Clear Logs
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="refreshData()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Endpoint</th>
                                <th>IP Address</th>
                                <th>Project Type</th>
                                <th>Tokens</th>
                                <th>Cost</th>
                                <th>Response Time</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            <tr>
                                <td colspan="8" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BACKEND_API_URL = window.BACKEND_API_URL || 'https://nyc-renovation-experts-1w7m8c1u7-nikunjan-gcs-projects.vercel.app';
        let adminToken = localStorage.getItem('adminToken');

        // Check if already logged in
        if (adminToken) {
            showDashboard();
        }

        async function login() {
            const password = document.getElementById('adminPassword').value;
            if (!password) {
                showError('Please enter password');
                return;
            }

            // Store token in localStorage (simple auth)
            localStorage.setItem('adminToken', password);
            adminToken = password;

            // Test auth
            try {
                const response = await fetch(`${BACKEND_API_URL}/admin/stats`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                if (response.ok) {
                    showDashboard();
                } else {
                    throw new Error('Invalid password');
                }
            } catch (error) {
                localStorage.removeItem('adminToken');
                showError('Invalid password. Please try again.');
            }
        }

        function logout() {
            localStorage.removeItem('adminToken');
            adminToken = null;
            document.getElementById('loginScreen').classList.remove('d-none');
            document.getElementById('dashboard').classList.add('d-none');
        }

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('d-none');
        }

        function showDashboard() {
            document.getElementById('loginScreen').classList.add('d-none');
            document.getElementById('dashboard').classList.remove('d-none');
            refreshData();
            setInterval(refreshData, 30000); // Refresh every 30 seconds
        }

        async function refreshData() {
            try {
                const [statsResponse, logsResponse] = await Promise.all([
                    fetch(`${BACKEND_API_URL}/admin/stats`, {
                        headers: {
                            'Authorization': `Bearer ${adminToken}`
                        }
                    }),
                    fetch(`${BACKEND_API_URL}/admin/logs?limit=50`, {
                        headers: {
                            'Authorization': `Bearer ${adminToken}`
                        }
                    })
                ]);

                if (!statsResponse.ok || !logsResponse.ok) {
                    if (statsResponse.status === 401) {
                        logout();
                        return;
                    }
                    throw new Error('Failed to fetch data');
                }

                const stats = await statsResponse.json();
                const logsData = await logsResponse.json();

                updateStats(stats);
                updateLogs(logsData.logs);
                updateCharts(stats);
            } catch (error) {
                console.error('Error refreshing data:', error);
            }
        }

        function updateStats(stats) {
            const statsData = stats.stats || {};
            
            document.getElementById('totalCalls').textContent = statsData.totalCalls || 0;
            document.getElementById('totalCost').textContent = '$' + (statsData.totalCost || 0).toFixed(4);
            document.getElementById('totalTokens').textContent = (statsData.totalTokens || 0).toLocaleString();
            
            const successRate = statsData.totalCalls > 0
                ? ((statsData.successfulCalls / statsData.totalCalls) * 100).toFixed(1)
                : 0;
            document.getElementById('successRate').textContent = successRate + '%';
        }

        function updateLogs(logs) {
            const tbody = document.getElementById('logsTableBody');
            
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No logs yet</td></tr>';
                return;
            }

            tbody.innerHTML = logs.map(log => {
                const date = new Date(log.timestamp);
                const timeStr = date.toLocaleString();
                const statusBadge = log.success
                    ? '<span class="badge badge-success">Success</span>'
                    : '<span class="badge badge-danger">Failed</span>';

                return `
                    <tr>
                        <td>${timeStr}</td>
                        <td><code>${log.endpoint}</code></td>
                        <td>${log.ip}</td>
                        <td>${log.projectType || 'N/A'}</td>
                        <td>${log.tokensUsed.toLocaleString()}</td>
                        <td>$${log.cost.toFixed(4)}</td>
                        <td>${log.responseTime}ms</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateCharts(stats) {
            // Usage by Date Chart
            const dateStats = stats.stats?.byDate || {};
            const dates = Object.keys(dateStats).sort();
            const callsData = dates.map(date => dateStats[date].calls);
            const costData = dates.map(date => dateStats[date].cost);

            if (window.usageChart) {
                window.usageChart.destroy();
            }

            const usageCtx = document.getElementById('usageChart').getContext('2d');
            window.usageChart = new Chart(usageCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'API Calls',
                        data: callsData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true
                }
            });

            // Usage by Endpoint Chart
            const endpointStats = stats.stats?.byEndpoint || {};
            const endpoints = Object.keys(endpointStats);
            const endpointData = endpoints.map(ep => endpointStats[ep].count);

            if (window.endpointChart) {
                window.endpointChart.destroy();
            }

            const endpointCtx = document.getElementById('endpointChart').getContext('2d');
            window.endpointChart = new Chart(endpointCtx, {
                type: 'doughnut',
                data: {
                    labels: endpoints,
                    datasets: [{
                        data: endpointData,
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#4facfe',
                            '#00f2fe'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true
                }
            });
        }

        async function clearLogs() {
            if (!confirm('Are you sure you want to clear all logs? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`${BACKEND_API_URL}/admin/clear-logs`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                if (response.ok) {
                    alert('Logs cleared successfully');
                    refreshData();
                } else {
                    throw new Error('Failed to clear logs');
                }
            } catch (error) {
                alert('Error clearing logs: ' + error.message);
            }
        }
    </script>
</body>
</html>

