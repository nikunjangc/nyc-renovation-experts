<!DOCTYPE html>
<html lang="en">
<head>
    <base href="/">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Usage Dashboard - NYC Renovation Experts</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: #f5f7fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .stat-card .icon {
            font-size: 2.5rem;
            color: #667eea;
            margin-bottom: 1rem;
        }
        .stat-card h3 {
            font-size: 2rem;
            font-weight: bold;
            margin: 0;
        }
        .stat-card p {
            color: #666;
            margin: 0.5rem 0 0 0;
        }
        .logs-table {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .badge-success {
            background: #28a745;
        }
        .badge-danger {
            background: #dc3545;
        }
        .login-form {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        .table-responsive {
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-form">
        <h2 class="mb-4"><i class="fas fa-lock me-2"></i>Admin Login</h2>
        <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" class="form-control" id="adminPassword" placeholder="Enter admin password">
        </div>
        <button class="btn btn-primary w-100" onclick="login()">
            <i class="fas fa-sign-in-alt me-2"></i>Login
        </button>
        <div id="loginError" class="alert alert-danger mt-3 d-none"></div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="d-none">
        <div class="dashboard-header">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1><i class="fas fa-chart-line me-2"></i>API Usage Dashboard</h1>
                        <p class="mb-0">Monitor your AI API usage and costs</p>
                    </div>
                    <button class="btn btn-light" onclick="logout()">
                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>

        <div class="container">
            <!-- Statistics Cards -->
            <div class="row">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="icon"><i class="fas fa-phone-alt"></i></div>
                        <h3 id="totalCalls">0</h3>
                        <p>Total API Calls</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="icon"><i class="fas fa-coins"></i></div>
                        <h3 id="totalCost">$0.00</h3>
                        <p>Total Cost</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="icon"><i class="fas fa-layer-group"></i></div>
                        <h3 id="totalTokens">0</h3>
                        <p>Total Tokens</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="icon"><i class="fas fa-check-circle"></i></div>
                        <h3 id="successRate">0%</h3>
                        <p>Success Rate</p>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="chart-container">
                        <h5 class="mb-3"><i class="fas fa-chart-bar me-2"></i>Usage by Date</h5>
                        <canvas id="usageChart"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-container">
                        <h5 class="mb-3"><i class="fas fa-chart-pie me-2"></i>Usage by Endpoint</h5>
                        <canvas id="endpointChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Quote.html Monitoring Section -->
            <div class="logs-table mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h5><i class="fas fa-file-alt me-2"></i>Quote.html Request Monitor</h5>
                        <p class="text-muted mb-0">Track all AI requests coming from quote.html page</p>
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                </div>
                
                <!-- Quote.html Stats -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="stat-card" style="padding: 1rem; margin-bottom: 0;">
                            <small class="text-muted">Quote.html Requests</small>
                            <h4 id="quoteRequests">0</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="padding: 1rem; margin-bottom: 0;">
                            <small class="text-muted">Success Rate</small>
                            <h4 id="quoteSuccessRate">0%</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="padding: 1rem; margin-bottom: 0;">
                            <small class="text-muted">Total Cost</small>
                            <h4 id="quoteTotalCost">$0.00</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="padding: 1rem; margin-bottom: 0;">
                            <small class="text-muted">Avg Response Time</small>
                            <h4 id="quoteAvgResponse">0ms</h4>
                        </div>
                    </div>
                </div>
                
                <!-- Quote.html Logs -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Endpoint</th>
                                <th>IP Address</th>
                                <th>Project Type</th>
                                <th>Borough</th>
                                <th>Tokens</th>
                                <th>Cost</th>
                                <th>Response Time</th>
                                <th>Status</th>
                                <th>AI Status</th>
                            </tr>
                        </thead>
                        <tbody id="quoteLogsTableBody">
                            <tr>
                                <td colspan="10" class="text-center">Loading quote.html requests...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="alert alert-info mt-3 mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Status Indicator:</strong> 
                    <span class="badge badge-success">Success</span> = Request reached AI and got response | 
                    <span class="badge badge-danger">Failed</span> = Request failed to reach AI or got error
                </div>
            </div>

            <!-- All Recent Logs -->
            <div class="logs-table">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5><i class="fas fa-list me-2"></i>All Recent API Calls</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-danger me-2" onclick="clearLogs()">
                            <i class="fas fa-trash me-2"></i>Clear Logs
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="refreshData()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Endpoint</th>
                                <th>Source</th>
                                <th>IP Address</th>
                                <th>Project Type</th>
                                <th>Tokens</th>
                                <th>Cost</th>
                                <th>Response Time</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            <tr>
                                <td colspan="8" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Backend URL - Frontend on GitHub Pages, Backend on Vercel
        // IMPORTANT: Using actual Vercel URL (not custom domain)
        // Custom domain (www.nycrenovationexperts.com) points to GitHub Pages (frontend), not Vercel (backend)
        const BACKEND_API_URL = window.BACKEND_API_URL || 'https://nyc-renovation-experts-q6k244xd3-nikunjan-gcs-projects.vercel.app';
        
        // Test backend connection on page load
        (async function testBackendOnLoad() {
            try {
                const response = await fetch(`${BACKEND_API_URL}/health`, { 
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('application/json')) {
                    console.log('✅ Backend connection OK - using:', BACKEND_API_URL);
                } else {
                    console.warn('⚠️ Backend connection issue - received HTML instead of JSON');
                    console.warn('Current URL:', BACKEND_API_URL);
                    console.warn('This URL might be pointing to GitHub Pages instead of Vercel!');
                    console.warn('Find your Vercel URL at: https://vercel.com/dashboard');
                }
            } catch (error) {
                console.error('❌ Cannot connect to backend:', error);
                console.error('Current URL:', BACKEND_API_URL);
                console.error('Please check your Vercel deployment and update BACKEND_API_URL!');
            }
        })();
        
        let adminToken = localStorage.getItem('adminToken');

        // Check if already logged in
        if (adminToken) {
            showDashboard();
        }

        async function login() {
            const password = document.getElementById('adminPassword').value;
            if (!password) {
                showError('Please enter password');
                return;
            }

            // Store token in localStorage (simple auth)
            localStorage.setItem('adminToken', password);
            adminToken = password;

            // Test auth
            try {
                console.log(`[Login] Attempting to connect to: ${BACKEND_API_URL}/admin/stats`);
                console.log(`[Login] Origin: ${window.location.origin}`);
                
                const response = await fetch(`${BACKEND_API_URL}/admin/stats`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include',
                    mode: 'cors'
                });

                console.log(`[Login] Response status: ${response.status}`);
                console.log(`[Login] Response headers:`, [...response.headers.entries()]);

                if (response.ok) {
                    const data = await response.json().catch(() => null);
                    console.log('[Login] Success!', data);
                    showDashboard();
                } else {
                    const contentType = response.headers.get('content-type');
                    let errorData = '';
                    
                    if (contentType && contentType.includes('application/json')) {
                        const jsonData = await response.json().catch(() => null);
                        errorData = jsonData ? JSON.stringify(jsonData) : '';
                    } else {
                        errorData = await response.text().catch(() => '');
                    }
                    
                    console.error('[Login] Failed:', {
                        status: response.status,
                        statusText: response.statusText,
                        errorData: errorData.substring(0, 200),
                        contentType
                    });
                    
                    if (response.status === 401) {
                        showError('Invalid password. Please try again.');
                    } else if (response.status === 0) {
                        showError('CORS error - Backend not accessible. Check if Vercel deployment is ready.');
                        console.error('[Login] CORS Error - Request was blocked. Check Vercel deployment status.');
                    } else {
                        showError(`Error: ${response.status} ${response.statusText}`);
                    }
                }
            } catch (error) {
                console.error('[Login] Exception:', error);
                localStorage.removeItem('adminToken');
                
                // Detailed error message
                const errorMsg = `
Connection error. Details:
- Backend URL: ${BACKEND_API_URL}
- Error: ${error.message}
- Error Type: ${error.name}

Common causes:
1. CORS issue - Backend not allowing requests from ${window.location.origin}
2. Network error - Vercel deployment might not be ready
3. DNS issue - Backend URL might be incorrect

Next steps:
1. Check Vercel dashboard: https://vercel.com/dashboard
2. Verify deployment is "Ready"
3. Check browser console Network tab for detailed error
4. Try the health endpoint: ${BACKEND_API_URL}/health
                `.trim();
                
                showError('Connection error. Check browser console (F12) for details.');
                console.error(errorMsg);
                
                // Try to test health endpoint
                fetch(`${BACKEND_API_URL}/health`)
                    .then(r => r.json())
                    .then(data => console.log('[Health Check] Success:', data))
                    .catch(e => console.error('[Health Check] Failed:', e));
            }
        }

        function logout() {
            localStorage.removeItem('adminToken');
            adminToken = null;
            document.getElementById('loginScreen').classList.remove('d-none');
            document.getElementById('dashboard').classList.add('d-none');
        }

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('d-none');
        }

        function showDashboard() {
            document.getElementById('loginScreen').classList.add('d-none');
            document.getElementById('dashboard').classList.remove('d-none');
            refreshData();
            setInterval(refreshData, 30000); // Refresh every 30 seconds
        }

        async function refreshData() {
            try {
                const [statsResponse, logsResponse, quoteLogsResponse] = await Promise.all([
                    fetch(`${BACKEND_API_URL}/admin/stats`, {
                        headers: {
                            'Authorization': `Bearer ${adminToken}`
                        }
                    }),
                    fetch(`${BACKEND_API_URL}/admin/logs?limit=50`, {
                        headers: {
                            'Authorization': `Bearer ${adminToken}`
                        }
                    }),
                    fetch(`${BACKEND_API_URL}/admin/logs?limit=50&source=quote.html`, {
                        headers: {
                            'Authorization': `Bearer ${adminToken}`
                        }
                    })
                ]);

                if (!statsResponse.ok || !logsResponse.ok || !quoteLogsResponse.ok) {
                    if (statsResponse.status === 401) {
                        logout();
                        return;
                    }
                    throw new Error('Failed to fetch data');
                }

                const stats = await statsResponse.json();
                const logsData = await logsResponse.json();
                const quoteLogsData = await quoteLogsResponse.json();

                updateStats(stats);
                updateLogs(logsData.logs);
                updateQuoteLogs(quoteLogsData.logs);
                updateCharts(stats);
            } catch (error) {
                console.error('Error refreshing data:', error);
            }
        }

        function updateStats(stats) {
            const statsData = stats.stats || {};
            
            document.getElementById('totalCalls').textContent = statsData.totalCalls || 0;
            document.getElementById('totalCost').textContent = '$' + (statsData.totalCost || 0).toFixed(4);
            document.getElementById('totalTokens').textContent = (statsData.totalTokens || 0).toLocaleString();
            
            const successRate = statsData.totalCalls > 0
                ? ((statsData.successfulCalls / statsData.totalCalls) * 100).toFixed(1)
                : 0;
            document.getElementById('successRate').textContent = successRate + '%';
        }

        function updateLogs(logs) {
            const tbody = document.getElementById('logsTableBody');
            
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">No logs yet</td></tr>';
                return;
            }

            tbody.innerHTML = logs.map(log => {
                const date = new Date(log.timestamp);
                const timeStr = date.toLocaleString();
                const statusBadge = log.success
                    ? '<span class="badge badge-success">Success</span>'
                    : '<span class="badge badge-danger">Failed</span>';
                const sourceBadge = log.source === 'quote.html'
                    ? '<span class="badge bg-info">quote.html</span>'
                    : '<span class="badge bg-secondary">other</span>';

                return `
                    <tr>
                        <td>${timeStr}</td>
                        <td><code>${log.endpoint}</code></td>
                        <td>${sourceBadge}</td>
                        <td>${log.ip}</td>
                        <td>${log.projectType || 'N/A'}</td>
                        <td>${log.tokensUsed.toLocaleString()}</td>
                        <td>$${log.cost.toFixed(4)}</td>
                        <td>${log.responseTime}ms</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateQuoteLogs(logs) {
            const tbody = document.getElementById('quoteLogsTableBody');
            
            // Calculate stats for quote.html
            const quoteStats = {
                total: logs.length,
                successful: logs.filter(log => log.success).length,
                totalCost: logs.reduce((sum, log) => sum + (log.cost || 0), 0),
                avgResponseTime: logs.length > 0
                    ? Math.round(logs.reduce((sum, log) => sum + (log.responseTime || 0), 0) / logs.length)
                    : 0
            };
            
            // Update quote.html stats
            document.getElementById('quoteRequests').textContent = quoteStats.total;
            document.getElementById('quoteSuccessRate').textContent = quoteStats.total > 0
                ? ((quoteStats.successful / quoteStats.total) * 100).toFixed(1) + '%'
                : '0%';
            document.getElementById('quoteTotalCost').textContent = '$' + quoteStats.totalCost.toFixed(4);
            document.getElementById('quoteAvgResponse').textContent = quoteStats.avgResponseTime + 'ms';
            
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">No requests from quote.html yet. Try submitting a quote to see it here!</td></tr>';
                return;
            }

            tbody.innerHTML = logs.map(log => {
                const date = new Date(log.timestamp);
                const timeStr = date.toLocaleString();
                const statusBadge = log.success
                    ? '<span class="badge badge-success">✓ Success</span>'
                    : '<span class="badge badge-danger">✗ Failed</span>';
                
                // AI Status indicator
                const aiStatus = log.success && log.tokensUsed > 0
                    ? '<span class="badge bg-success">AI Responded</span>'
                    : log.success && log.tokensUsed === 0
                    ? '<span class="badge bg-warning">No AI Call</span>'
                    : '<span class="badge bg-danger">AI Error</span>';

                // Extract borough from referer if available
                const borough = log.projectType ? log.projectType.split('-')[0] : 'N/A';

                return `
                    <tr>
                        <td>${timeStr}</td>
                        <td><code>${log.endpoint}</code></td>
                        <td>${log.ip}</td>
                        <td>${log.projectType || 'N/A'}</td>
                        <td>${borough}</td>
                        <td>${log.tokensUsed.toLocaleString()}</td>
                        <td>$${log.cost.toFixed(4)}</td>
                        <td>${log.responseTime}ms</td>
                        <td>${statusBadge}</td>
                        <td>${aiStatus}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateCharts(stats) {
            // Usage by Date Chart
            const dateStats = stats.stats?.byDate || {};
            const dates = Object.keys(dateStats).sort();
            const callsData = dates.map(date => dateStats[date].calls);
            const costData = dates.map(date => dateStats[date].cost);

            if (window.usageChart) {
                window.usageChart.destroy();
            }

            const usageCtx = document.getElementById('usageChart').getContext('2d');
            window.usageChart = new Chart(usageCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'API Calls',
                        data: callsData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true
                }
            });

            // Usage by Endpoint Chart
            const endpointStats = stats.stats?.byEndpoint || {};
            const endpoints = Object.keys(endpointStats);
            const endpointData = endpoints.map(ep => endpointStats[ep].count);

            if (window.endpointChart) {
                window.endpointChart.destroy();
            }

            const endpointCtx = document.getElementById('endpointChart').getContext('2d');
            window.endpointChart = new Chart(endpointCtx, {
                type: 'doughnut',
                data: {
                    labels: endpoints,
                    datasets: [{
                        data: endpointData,
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#4facfe',
                            '#00f2fe'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true
                }
            });
        }

        async function clearLogs() {
            if (!confirm('Are you sure you want to clear all logs? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`${BACKEND_API_URL}/admin/clear-logs`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                if (response.ok) {
                    alert('Logs cleared successfully');
                    refreshData();
                } else {
                    throw new Error('Failed to clear logs');
                }
            } catch (error) {
                alert('Error clearing logs: ' + error.message);
            }
        }
    </script>
</body>
</html>

